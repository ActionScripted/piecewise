<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Pennsylvania Broadband Mapping Initiative</title>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
  <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.6/mapbox.css' rel='stylesheet' />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link href='css/ndt_d3.css' rel='stylesheet' />
  <link href="css/jquery-ui-slider-pips.css" rel="stylesheet" />
  <link href='css/jquery-ui.min.css' rel='stylesheet' />
  <link href='css/mlab.css' rel='stylesheet' />
  <script src='//api.tiles.mapbox.com/mapbox.js/v2.1.6/mapbox.js'></script>
  <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src='js/mlab.js'></script>
  <script src='js/ndt.js'></script>
  <script src='js/ndt_d3.js'></script>
  <script src='js/d3.v3.min.js'></script>
  <script src='js/center.js'></script>
  <script src="js/jquery-ui.min.js"></script>
  <script src="js/jquery-ui-slider-pips.min.js"></script>
</head>

<body>

<div id="spinner">
  <div id="spin">&nbsp;</div>
  <div id="loading">LOADING</div>
</div>

<div id="welcome-container">
  <div id="header">
    <div id="intro">
      <h3>Taking part in the Pennsylvania Broadband Mapping Initiative?  Check your Internet speed in roughly 30 seconds!
</h3>
      <p>The Measurement Lab (M-Lab) platform is run by the scientific community. We make all test results publicly available via the MeasurementLab.net website  to help promote Internet research. M-Lab's Network Diagnostic Tool collects a number  of measures of different facets of your Internet connection. The information published includes each deviceâ€™s IP address, but does not include personal identifying information about you as an Internet user.
  
</p>
    </div>
  </div>
  <div id="sidebar">
    <form action="/collector/collect" method="get" id="collector">
      <div id="extra-data" class="ndt-related">
      <table id="form_fields">
      <tr>
          <td>Are you testing from your home, a business, or a community institution like a school or library?</td>
          <td>
        <select id="test_loc" name="test_loc" class="form-control">
          <option value="a_default">------</option><option value="b_home">Home</option><option value="c_school">School</option><option value="d_library">Library</option><option value="e_work">Work</option><option value="f_other">Other location</option></select>
        </td>
        </tr>
        <tr>
          <td>If you're not testing from your home, Do you have internet service at home?</td>
          <td>
        <select id="service_at_home" name="service_at_home" class="form-control">
          <option value="a_default">------</option><option value="b_home_serv_yes">Yes</option><option value="c_home_serv_no">No</option></select>
        </td>
        </tr>
        <tr>
          <td>If you do not have internet service at home, why not?</td>
          <td>
        <select id="no_serv_reason" name="no_serv_reason" class="form-control">
          <option value="a_default">------</option><option value="b_cost">Cost</option><option value="c_no_device">Do not have a computer/device</option><option value="d_no_expertise">Do not know how to use it</option><option value="e_no_interest">Do not want the internet</option><option value="f_mobile_only">Only have a mobile</option></select>
        </td>
        </tr>
        <tr>
          <td>If testing from your home, how many people in your household use the internet?</td>
          <td>
        <select id="household_num" name="household_num" class="form-control">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10+</option><option value="default" selected>------</option></select>
        </td>
        </tr>
        <tr>
          <td>What type of household do you live in?</td>
          <td>
        <select id="household_type" name="household_type" class="form-control">
          <option value="apartment_building">Apartment Building</option><option value="default" selected>------</option><option value="multi_fam_home">Multi-family home</option><option value="other">Other</option><option value="single_fam_home">Single-family home</option></select>
        </td>
        </tr>
        <tr>
          <td>If you selected 'other', please describe your household type:</td>
          <td>
        <input id="household_type_other" type="text" name="household_type_other" class="form-control"/>
        </td>
        </tr>
        <tr>
          <td>What company provides your internet service at home?</td>
          <td>
        <input id="isp_user" type="text" name="isp_user" class="form-control"/>
        </td>
        </tr>
        <tr>
          <td>What type of internet service is it?</td>
          <td>
        <select id="service_type" name="service_type" class="form-control">
          <option value="cable">Cable</option><option value="default" selected>------</option><option value="dsl">DSL</option><option value="fiber">Fiber</option><option value="mobile">Mobile (cellular)</option><option value="satellite">Satellite</option><option value="wireless_isp">Wireless/WISP</option></select>
        </td>
        </tr>
        <tr>
          <td>What is the download speed of your internet service subscription?</td>
          <td>
        <select id="download_speed" name="download_speed" class="form-control">
          <option value="100_mbps">100+ Mbps</option><option value="10_mbps">10 Mbps</option><option value="25_mbps">25 Mbps</option><option value="50_mbps">50 Mbps</option><option value="other">Other</option></select>
        </td>
        </tr>
        <tr>
          <td>What is the upload speed of your internet service subscription?</td>
          <td>
        <select id="upload_speed" name="upload_speed" class="form-control">
          <option value="100_mbps">100+ Mbps</option><option value="10_mbps">10 Mbps</option><option value="1_mbps">1 Mbps</option><option value="25_mbps">25 Mbps</option><option value="3_mbps">3 Mbps</option><option value="50_mbps">50 Mbps</option><option value="other">Other</option></select>
        </td>
        </tr>
        <tr>
          <td>Other download speed (if not listed above):</td>
          <td>
        <input id="other_download" type="text" name="other_download" class="form-control"/>
        </td>
        </tr>
        <tr>
          <td>Other upload speed (if not listed above):</td>
          <td>
        <input id="other_upload" type="text" name="other_upload" class="form-control"/>
        </td>
        </tr>
        <tr>
          <td>How much does it cost per month?</td>
          <td>
        <select id="service_cost" name="service_cost" class="form-control">
          <option value="100_plus">$100+</option><option value="bet_25_50">$25-50</option><option value="bet_50_75">$50-75</option><option value="bet_75_100">$75-100</option><option value="default" selected>------</option><option value="dont_know">I don't know</option><option value="less_than_25">Less than $25</option></select>
        </td>
        </tr>
        </table>

        <div class="container" id="consent-text">
        <p>
          <span class="required">*</span> <input type="checkbox" name="data_acknowledgement" id="data_acknowledgement" value="yes" /> I agree to the <a href="http://www.measurementlab.net/privacy/">M-Lab privacy policy</a>, which includes retention and publication of IP addresses, in addition to speed test results.

        </p>
        </div>
        <input name="latitude" id="latitude" type="hidden" />
        <input name="longitude" id="longitude" type="hidden" />
        <input name="actual_download" id="actual_download" type="hidden" />
        <input name="actual_upload" id="actual_upload" type="hidden" />
        <input name="min_rtt" id="min_rtt" type="hidden" />
        <input name="bigquery_key" id="bigquery_key" type="hidden" />
      </div>
      <div id="test-container">
        <div id="ndt-div">
          <div id="ndt-svg"></div>
        </div>
	    <div id="approx-loc">
	      <h3 class="league-gothic">Test your speed!</h3>
	      <div id="ndt-status"></div>
	    </div>
	    <div id="ndt-results" class="ndt-related">
	      <div class="container">
	        <div id="your-results">
	          <h3 class="league-gothic">Your test results</h3>
	          <p>Download speed: <span id="s2cRate"></span> Mbps</p>
	          <p>Upload speed: <span id="c2sRate"></span> Mbps</p>
	          <p>Minimum Round Trip Time: <span id="MinRTT"></span> ms</p>
	        </div>
	        <div id="thankyou">
	          <h3 class="league-gothic">Thank you!</h3>
	          <strong>Your test results will be combined with others and will appear on the map soon.
</strong><br /><br />
	          <strong>What do you want to do next?</strong>
	          <ul>
	            <li><a href="#" onclick="showMap()">View all results to-date on a map of Pennsylvania</a></li>
	            <li><a href="https://broadbandtest.us/" target="_parent">Learn more about this test and how to improve your speed</a></li>
	            <li><a href="#" onclick="showSocialShare()">none</a></li>
	          </ul>
	          <div id="socialshare">
	          <!-- Social Button HTML -->
	          <!-- Twitter -->
	            <a href="none"" target="_blank" class="share-btn twitter">
	            <i class="fa fa-twitter"></i>
	            </a>
	          <!-- Google Plus -->
	            <a href="none" target="_blank" class="share-btn google-plus">
	            <i class="fa fa-google-plus"></i>
	            </a>
	          <!-- Facebook -->
	            <a href="none" target="_blank" class="share-btn facebook">
	            <i class="fa fa-facebook"></i>
	            </a>
	          <!-- StumbleUpon (url, title) -->
	            <a href="none" target="_blank" class="share-btn stumbleupon">
	            <i class="fa fa-stumbleupon"></i>
	            </a>
	          <!-- Reddit (url, title) -->
	            <a href="none" target="_blank" class="share-btn reddit">
	            <i class="fa fa-reddit"></i>
	            </a>
	          <!-- LinkedIn -->
	            <a href="none" target="_blank" class="share-btn linkedin">
	            <i class="fa fa-linkedin"></i>
	            </a>
	          <!-- Email -->
	            <a href="none" target="_blank" class="share-btn email">
	            <i class="fa fa-envelope"></i>
	            </a>
	          </div>
	        </div> <!-- thankyou div -->
	      </div>
	    </div>
	  </div>
    </form>
    <div id="icons">
      <div id="take-test" onclick="runTest()">
        <img src="images/speed.svg" id="test-icon" alt="Take the Speed Test" title="Take the Speed Test" /><span class="button-label">Take the Speed Test</span>
      </div>
      <div id="explore-map" onclick="showMap()">
        <img src="images/compass.png" id="exploreMap" alt="Browse the Broadband Map" title="Browse the Broadband Map" /><span class="button-label">Browse the Broadband Map</span>
      </div>
      <div id="learn-more">
        <a href="https://broadbandtest.us/" target="_parent" ><img src="images/about.svg" alt="Learn more about this test." title="Learn more about this test." /><span class="button-label">Learn More</span></a>
      </div>
    </div>
  </div>
</div>
<script>
var ndtServer,
	ndtServerIp,
	ndtPort = "3010",
	ndtProtocol = 'wss',
	ndtPath = "/ndt_protocol",
	ndtUpdateInterval = 1000,
	c2sRate,
	s2cRate,
	MinRTT;

getNdtServer();

uncheckAcknowledgement();

NDT_meter = new NDTmeter('#ndt-svg');
NDT_meter.meter.on("click", function () {
	NDT_client = new NDTjs(ndtServer, ndtPort, ndtProtocol, ndtPath, NDT_meter, ndtUpdateInterval);
	NDT_client.startTest();
});

if ("geolocation" in navigator) {
	navigator.geolocation.getCurrentPosition(success, error);
}

function success(position) {

	document.getElementById('latitude').value = position.coords.latitude;
	document.getElementById('longitude').value = position.coords.longitude;

	var xhr = new XMLHttpRequest(),
	currentLocationURL = "https://nominatim.openstreetmap.org/reverse?format=json&lat=" + position.coords.latitude + "&lon=" + position.coords.longitude + "&zoom=18&addressdetails=1";

	var currentLoc;
	xhr.open('GET', currentLocationURL, true);
	xhr.send();
	xhr.onreadystatechange = function () {
		if (xhr.readyState === 4) {
			if (xhr.status === 200) {
				currentLoc = JSON.parse(xhr.responseText);
				console.log("Location received");

				// currentLocText.text(currentLoc.address.road + currentLoc.address.neighbourhood + currentLoc.address.suburb + currentLoc.address.city + currentLoc.address.state);
				$('#mobile-container').append('<div id="mobile-approx-loc"></div>')
				$('#approx-loc, #mobile-approx-loc').append("<p>Searching from:</p><p>" + currentLoc.address.road + ", " + currentLoc.address.city + ", " + currentLoc.address.state + "</p>");
			} else {
				console.log('Location lookup failed');
			}
		}
	};
}

function error(error) {
	document.getElementById('msg').innerHTML = 'ERROR(' + error.code + '): ' + error.message;
}

function getNdtServer () {
	var xhr = new XMLHttpRequest(),
		mlabNsUrl = 'https://mlab-ns.appspot.com/ndt_ssl?format=json';

	xhr.open('GET', mlabNsUrl, true);
	xhr.send();
	xhr.onreadystatechange = function () {
		if (xhr.readyState === 4) {
			if (xhr.status === 200) {
				ndtServer = JSON.parse(xhr.responseText).fqdn;
				ndtServerIp = JSON.parse(xhr.responseText).ip;
				console.log('Using M-Lab Server ' + ndtServer);
			} else {
				console.log('M-Lab NS lookup failed.');
			}
		}
	};
};
</script>

<div id="map">
  <div id="mapview-icons">
  <a href="index.html" alt="Take the Speed Test" title="Take the Speed Test"><img src="images/speed.svg" id="mapview-test-icon" alt="Take the Speed Test" title="Take the Speed Test" /></a>
  <a href="https://broadbandtest.us/" target="_parent" ><img src="images/about.svg" alt="Learn more about this test." title="Learn more about this test." /></a>
</div>

<script>
  // This is the Piecewise mapping script.

  // If set to 'hex' then GeoJSON files are assumed to be named like
  // 'YYYY_MM-<resolution>.json', where 3 files exist for each of resolutions
  // 'low', 'medium', 'high'.  If anything other than 'hex', then this value is
  // the MMMM_YY- suffix to look for. For example:
  // If set to 'city_council_districts', then the system will look for
  // GeoJSON files like 'MMMM_YY-city_council_districts.geojson'.

  // polygonType is a variable name defining your aggregation regions.
  // Change the name to reflect the aggregated regions you are using if needed.
  var polygonType = 'pa_state_upper_house';

  // Either 'topojson' or 'geojson'.  The Node.js script creates both TopoJSON and
  // GeoJSON files.  TopoJSON files are significantly smaller in size, but need to
  // be converted to GeoJSON by the browser.  There may be some balance between
  // loading a smaller file across the network and the processing time on the
  // client-side to convert the TopJSON to GeoJSON.  I would conjecture that
  // the network is the most limiting factor and that generally TopoJSON will be
  // the right choice.  TODO: prove this theory.
  var jsonType = 'topojson';

  // The minimum number of data points in any given polygon for a it to be
  // considered statistically relevant.  These cells will either not be displayed
  // or will be displayed with a different styling.
  var minDataPoints = '1';

  // Defines how each overlay is treated on load.  If an overlay is enabled, then
  // there will be a checkbox for it in the layers control. 'defaultOn' determines
  // whether it will be displayed by default. NOTE: If only a single overlay is
  // enabled, then no checkbox will be displayed, since it doesn't make much sense
  // to disable the only meaningful layer that exists.
  var overlays = {
    'polygon': {
  	  'enabled': true,
  	  'defaultOn': true
    },
    'plot': {
      'enabled': false,
      'defaultOn': false
    }
  };

  // Defines the layers that are going to be added to the map.
  var geoLayers = {
    'pa_state_upper_house': {
      'name': 'Pennsylvania State Upper House Districts',
      'polygonFile': 'geofiles/US_PA_2017_upper_house.topojson',
      'dataUrl': 'stats/q/pa_state_upper_house_districts?format=json&stats=AverageRTT,DownloadCount,MedianDownload,AverageDownload,UploadCount,MedianUpload,AverageUpload,DownloadMax,UploadMax&b.spatial_join=key&b.time_slices=year&f.time_slices=',
      'dbKey': 'geoid',
      'geoKey': 'GEOID',
      'cache': null,
      'layer': null
    },
  };

  // Which of the geoLayers should be the one added to the map by default
  var defaultLayer = 'pa_state_upper_house';

  // If set to true, then prefetch the GeoJSON files into a local cache.  WARNING:
  // You may not want to enable if you expect mobile, low bandwidth, or otherwise
  // bandwidth restricted users, as this can pull in many megabytes of data.
  var seedCache = false;

  // The inteval (in milliseconds) to use when animating the map.
  var animateInterval = 1500;

  var zoom = 8;

  // These are the labels that will be used for the month slider in the control
  // box in the lower left corner.
  //

  var monthNames = ['2018'];

  // An object which will hold cached GeoJSON files so that we don't have to fetch
  // them from the server more than once.  This could potentially be problematic
  // if there are many files and they are large.
  var geoJsonCache = {};
  var geometryCache = null;

  // The oldest year and month for which we have data.
  var startYear = 2018;
  var startMonth = 1;

  // Get current year/month into variables
  var currentYear = new Date().getFullYear();
  var currentMonth = new Date().getMonth() + 1;
  // Zero pad the front of the month
  currentMonth = currentMonth < 10 ? '0' + currentMonth : currentMonth;

  // Be sure that we actually have data for the current month.  If not, then fall
  // back to the previous month.
  var start = Date.UTC(currentYear) / 1000;
  var end = Math.floor(Date.UTC(currentYear) / 1000);
  var dataUrl = geoLayers[defaultLayer]['dataUrl'] + start + ',' + end;
  $.ajax({
  	url: dataUrl,
  	dataType: 'json',
  	async: false,
    success: function(resp) {
  	  if ( ! resp.features.length ) {
  	    if ( currentMonth == '01' ) {
  	      currentMonth = 12;
  	      currentYear = currentYear - 1;
  	    } else {
  	      currentMonth = currentMonth - 1;
  	      currentMonth = currentMonth < 10 ? '0' + currentMonth : currentMonth;
  	    }
  	    console.log("No data for current year/month, using last month instead.");
  	  }
    }
  });

  // An object with the years and months we have data for.  This will be used to
  // auto-generate various form controls.
  var dates = {};
  var thisYear = startYear;
  while (thisYear <= currentYear) {
    if (thisYear == currentYear) {
      var months = [];
      for (i = 1; i <= currentMonth; i++) { months.push(i) };
        dates[thisYear] = months
    } else {
      dates[thisYear] = ['1','2','3','4','5','6','7','8','9','10','11','12'];
    }
    thisYear++;
  }

// Create the map
var map = L.map('map', {zoomControl: false}).setView(center, zoom);
map.scrollWheelZoom.disable();
var control = L.control.zoom({position: 'topright'});
map.addControl(control);

// Set the base tile layer type
// Use Open Street Maps as a base tile layer
  var baseTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  });

// Set the default base tile layer.
map.addLayer(baseTileLayer);

// Add other base tile layer providers as needed
var baseLayers = {
  'osm': baseTileLayer
};

var layerCtrl = L.control.layers(baseLayers, null, { collapsed: false, position: 'bottomleft' });
addControls();
layerCtrl.addTo(map);
addLegend();

for (var geoLayer in geoLayers) {
  setupLayer(geoLayer);
}
</script>

</body>
</html>
